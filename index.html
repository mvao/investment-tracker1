<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Investment Tracker â€” Dark Neon</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #070707;
      --panel: #0f1720;
      --muted: #94a3b8;
      --neon: #00ff88;
      --neon-2: #00d1ff;
      --neon-3: #c084fc;
    }
    body {
      background: var(--bg);
      color: #e6eef8;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    .neon {
      box-shadow: 0 0 10px rgba(0, 255, 136, 0.08), 0 0 22px rgba(0, 255, 136, 0.04);
      border: 1px solid rgba(0, 255, 136, 0.12);
    }
    .glow {
      filter: drop-shadow(0 0 8px rgba(0, 255, 136, 0.22));
    }
    .card {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
      border: 1px solid rgba(255, 255, 255, 0.04);
    }
    details summary {
      list-style: none;
      cursor: pointer;
    }
    details[open] summary .chev {
      transform: rotate(90deg);
    }
  </style>
</head>
<body>
  <div class="max-w-5xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl font-semibold text-white">Investment Tracker</h1>
      <p class="text-sm text-slate-400">Dark neon theme Â· LocalStorage Â· Expand year rows to view inputs</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
      <form id="entryForm" class="lg:col-span-1 p-4 card rounded-lg neon">
        <h2 class="text-lg font-medium mb-3 glow" style="color:var(--neon)">Add entry</h2>
        <label class="text-xs text-slate-400">Month & Year</label>
        <input id="date" type="month" required class="mt-1 block w-full rounded p-2 bg-transparent border border-white/5 text-white text-sm" />

        <label class="text-xs text-slate-400 mt-3">Amount (R$)</label>
        <input id="amount" type="number" step="0.01" min="0" placeholder="0.00" required class="mt-1 block w-full rounded p-2 bg-transparent border border-white/5 text-white text-sm" />

        <label class="text-xs text-slate-400 mt-3">Category</label>
        <select id="category" class="mt-1 block w-full rounded p-2 bg-transparent border border-white/5 text-white text-sm">
          <option value="Brazil">Brazil</option>
          <option value="USA">USA</option>
          <option value="Crypto">Crypto</option>
        </select>

        <div class="mt-4 flex gap-2">
          <button type="submit" class="px-4 py-2 rounded bg-gradient-to-r from-green-400 to-green-300 text-black font-semibold">Add</button>
          <button type="button" id="clearAll" class="px-3 py-2 rounded border text-sm text-slate-200">Clear all</button>
        </div>

        <div class="mt-3 flex gap-2 text-xs">
          <button type="button" id="exportBtn" class="px-3 py-2 rounded border">Export JSON</button>
          <label class="px-3 py-2 rounded border cursor-pointer">Import JSON <input id="importFile" type="file" accept="application/json" class="hidden"/></label>
        </div>

        <p class="mt-3 text-xs text-slate-400">Entries are saved in your browser. Use export to backup.</p>
      </form>

      <div class="lg:col-span-2 p-4 card rounded-lg neon">
        <h2 class="text-lg font-medium mb-3 glow" style="color:var(--neon-2)">Invested over time</h2>
        <canvas id="lineChart" height="150"></canvas>
        <p class="mt-2 text-xs text-slate-400">Line chart shows cumulative invested value per category over time.</p>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <section id="section-Brazil" class="card p-4 rounded-lg neon">
        <h3 class="font-medium text-white mb-2 glow" style="color:var(--neon)">ðŸ‡§ðŸ‡· Brazil</h3>
        <div id="brazilSummary" class="text-sm text-slate-300"></div>
        <div id="brazilYears" class="mt-3"></div>
      </section>

      <section id="section-USA" class="card p-4 rounded-lg neon">
        <h3 class="font-medium text-white mb-2 glow" style="color:var(--neon-2)">ðŸ‡ºðŸ‡¸ USA</h3>
        <div id="usaSummary" class="text-sm text-slate-300"></div>
        <div id="usaYears" class="mt-3"></div>
      </section>

      <section id="section-Crypto" class="card p-4 rounded-lg neon">
        <h3 class="font-medium text-white mb-2 glow" style="color:var(--neon-3)">ðŸª™ Crypto</h3>
        <div id="cryptoSummary" class="text-sm text-slate-300"></div>
        <div id="cryptoYears" class="mt-3"></div>
      </section>
    </div>

    <footer class="mt-6 text-xs text-slate-500">Saved locally Â· Expand a year to see the inputs for that year</footer>
  </div>

  <script>
    const STORAGE_KEY = 'investment_tracker_dark_v3';
    const OLD_KEY = 'investment_tracker'; // previous white version key

    const currencyFormatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const monthFormatter = new Intl.DateTimeFormat('pt-BR', { month: 'short' });

    let chart;

    function createChart(ctx) {
      chart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: { legend: { labels: { color: '#cbd5e1' } } },
          scales: {
            x: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.03)' } },
            y: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.03)' } }
          }
        }
      });
    }

    function loadEntries() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.error(e);
        return [];
      }
    }

    function saveEntries(list) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }

    function parseMonthYear(v) {
      if (!v || !v.includes('-')) return null;
      const [y, m] = v.split('-').map(Number);
      if (isNaN(y) || isNaN(m)) return null;
      return { year: y, month: m };
    }

    function displayMonth(v) {
      const parsed = parseMonthYear(v);
      if (!parsed) return v;
      const { year, month } = parsed;
      const d = new Date(year, month - 1, 1);
      return `${monthFormatter.format(d).replace('.', '')} ${year}`;
    }

    function renderAll() {
      const entries = loadEntries().filter(e => parseMonthYear(e.date)).sort((a, b) => a.date.localeCompare(b.date));
      renderSections(entries);
      renderChart(entries);
      attachDeleteHandlers();
    }

    function groupByCategory(entries) {
      const map = { Brazil: [], USA: [], Crypto: [] };
      entries.forEach(e => {
        if (!map[e.category]) map[e.category] = [];
        map[e.category].push(e);
      });
      return map;
    }

    function aggregateByYear(list) {
      const byYear = {};
      let grand = 0;
      list.forEach(e => {
        const y = parseMonthYear(e.date)?.year;
        if (!y) return;
        byYear[y] = (byYear[y] || 0) + Number(e.amount);
        grand += Number(e.amount);
      });
      return { byYear, grand };
    }

    function renderSections(entries) {
      const grouped = groupByCategory(entries);
      renderCategory('Brazil', grouped['Brazil'], 'brazilSummary', 'brazilYears');
      renderCategory('USA', grouped['USA'], 'usaSummary', 'usaYears');
      renderCategory('Crypto', grouped['Crypto'], 'cryptoSummary', 'cryptoYears');
    }

    function renderCategory(catName, list, summaryId, yearsContainerId) {
      const summaryEl = document.getElementById(summaryId);
      const yearsEl = document.getElementById(yearsContainerId);
      const { byYear, grand } = aggregateByYear(list);
      summaryEl.textContent = `Grand total: ${currencyFormatter.format(grand)}`;
      yearsEl.innerHTML = '';
      if (Object.keys(byYear).length === 0) {
        yearsEl.innerHTML = `<div class='text-slate-400 text-sm'>No data</div>`;
        return;
      }
      Object.keys(byYear)
        .sort((a, b) => b - a)
        .forEach(year => {
          const total = byYear[year];
          const details = document.createElement('details');
          details.className = 'mb-2';
          details.innerHTML = `
            <summary class='flex justify-between items-center p-2 rounded hover:bg-white/2'>
              <div class='flex items-center gap-3'>
                <span class='chev'>â–¶</span>
                <div class='text-sm'>${year}</div>
              </div>
              <div class='text-sm font-medium'>${currencyFormatter.format(total)}</div>
            </summary>
            <div class='mt-2 text-sm bg-transparent p-2'>
              <table class='w-full'>
                <thead class='text-slate-400'><tr><th class='text-left py-1'>Month</th><th class='text-left py-1'>Amount</th><th class='text-left py-1'>Action</th></tr></thead>
                <tbody class='year-rows'></tbody>
              </table>
            </div>`;
          const tbody = details.querySelector('.year-rows');
          const rows = list.filter(e => parseMonthYear(e.date)?.year == Number(year)).sort((a, b) => a.date.localeCompare(b.date));
          rows.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class='py-1'>${displayMonth(r.date)}</td><td class='py-1'>${currencyFormatter.format(Number(r.amount))}</td><td class='py-1'><button data-id='${r.id}' class='delete-row text-xs text-red-400'>Delete</button></td>`;
            tbody.appendChild(tr);
          });
          yearsEl.appendChild(details);
        });
    }

    function renderChart(entries) {
      const valid = entries.filter(e => parseMonthYear(e.date));
      const months = Array.from(new Set(valid.map(e => e.date))).sort();
      if (months.length > 240) months.splice(240); // safety limit ~20 years

      const cats = ['Brazil', 'USA', 'Crypto'];
      const series = { Brazil: [], USA: [], Crypto: [] };
      let accum = { Brazil: 0, USA: 0, Crypto: 0 };

      months.forEach(mon => {
        const forMonth = valid.filter(e => e.date === mon);
        forMonth.forEach(e => {
          accum[e.category] = (accum[e.category] || 0) + Number(e.amount);
        });
        cats.forEach(c => series[c].push(accum[c] || 0));
      });

      const labels = months.map(m => displayMonth(m));
      const datasets = [
        { label: 'Brazil', data: series['Brazil'], borderColor: 'rgba(0,255,136,0.95)', tension: 0.3, pointRadius: 2 },
        { label: 'USA', data: series['USA'], borderColor: 'rgba(0,209,255,0.95)', tension: 0.3, pointRadius: 2 },
        { label: 'Crypto', data: series['Crypto'], borderColor: 'rgba(192,132,252,0.95)', tension: 0.3, pointRadius: 2 }
      ];

      if (!chart) {
        const ctx = document.getElementById('lineChart').getContext('2d');
        createChart(ctx);
      }
      chart.data.labels = labels;
      chart.data.datasets = datasets;
      chart.update();
    }

    function attachDeleteHandlers() {
      document.querySelectorAll('.delete-row').forEach(btn =>
        (btn.onclick = ev => {
          const id = ev.target.dataset.id;
          if (!confirm('Delete entry?')) return;
          const list = loadEntries();
          const idx = list.findIndex(i => i.id === id);
          if (idx > -1) {
            list.splice(idx, 1);
            saveEntries(list);
            renderAll();
          }
        })
      );
    }

    document.getElementById('entryForm').addEventListener('submit', e => {
      e.preventDefault();
      const date = document.getElementById('date').value;
      const amount = document.getElementById('amount').value;
      const category = document.getElementById('category').value;
      if (!date || !amount) return alert('Please fill month and amount');
      const list = loadEntries();
      list.push({ id: crypto.randomUUID(), date, amount: Number(amount), category });
      saveEntries(list);
      document.getElementById('amount').value = '';
      renderAll();
    });

    document.getElementById('clearAll').addEventListener('click', () => {
      if (!confirm('Delete ALL entries?')) return;
      localStorage.removeItem(STORAGE_KEY);
      renderAll();
    });

    document.getElementById('exportBtn').addEventListener('click', () => {
      const data = loadEntries();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'investment-backup.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('importFile').addEventListener('change', ev => {
      const file = ev.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const parsed = JSON.parse(e.target.result);
          if (!Array.isArray(parsed)) throw new Error('Invalid format');
          saveEntries(parsed);
          renderAll();
          alert('Import successful');
        } catch (err) {
          alert('Import failed: ' + err.message);
        }
      };
      reader.readAsText(file);
    });

    function tryImportOldData() {
      const old = localStorage.getItem(OLD_KEY);
      if (!old) return;
      try {
        const parsed = JSON.parse(old);
        if (!Array.isArray
