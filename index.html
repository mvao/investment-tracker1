<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Investment Tracker â€” Professional</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* New Professional Palette */
    :root {
      --bg: #1a1a2e; /* Darker background */
      --panel: #202040; /* Slightly lighter panel */
      --accent: #00bcd4; /* A sophisticated teal/cyan */
      --text: #e0e0e0; /* Light gray for main text */
      --muted: #a0a0b0; /* Muted gray for secondary text */
      --border: rgba(255, 255, 255, 0.08); /* Subtle border */
    }

    html, body { height: 100%; }
    body {
      background: linear-gradient(180deg, var(--bg) 0%, #17172b 100%);
      color: var(--text);
      font-family: 'Inter', 'Roboto', 'Helvetica Neue', Arial, sans-serif; /* Professional font stack */
      margin: 0;
    }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border: 1px solid var(--border);
      border-radius: 10px; /* Slightly softer corners */
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); /* Subtle shadow */
    }
    details summary { list-style: none; cursor: pointer; }
    details[open] summary .chev { transform: rotate(90deg); }
    label { display: block; }
    select, input[type="month"], input[type="number"] {
      appearance: none;
      -webkit-appearance: none;
      background: transparent;
      border: 1px solid var(--border);
      padding: .6rem .8rem;
      border-radius: 6px;
      color: var(--text);
      font-size: .95rem;
    }
    select option { background: var(--panel); color: var(--text); }
    /* Aumenta a altura do campo de categoria */
    select#category {
        padding-top: .7rem; /* Aumenta o padding superior */
        padding-bottom: .7rem; /* Aumenta o padding inferior */
        min-height: 40px; /* Garante uma altura mÃ­nima */
    }
    .notice {
      position: fixed; left: 50%; transform: translateX(-50%); top: 18px; z-index: 9999;
      padding: .6rem 1rem; border-radius: 8px;
      background: rgba(32, 32, 64, 0.9); /* Use panel color with transparency */
      backdrop-filter: blur(8px);
      color: var(--accent);
      border: 1px solid rgba(0, 188, 212, 0.2); /* Accent color border */
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
    }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: .5rem .75rem; text-align: left; font-size: .9rem; border-bottom: 1px solid rgba(255,255,255,0.02); }
    th { color: var(--muted); font-weight: 500; }
    .muted { color: var(--muted); }
    .small { font-size: .85rem; }
    .btn {
      padding: .6rem 1rem;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: linear-gradient(90deg, rgba(0,0,0,0.3), rgba(255,255,255,0.01));
      cursor: pointer;
      transition: background 0.2s ease, border-color 0.2s ease;
    }
    .btn:hover {
      background: linear-gradient(90deg, rgba(0,0,0,0.4), rgba(255,255,255,0.02));
      border-color: rgba(255,255,255,0.06);
    }
    .btn-primary {
      background: linear-gradient(90deg, var(--accent), #4dd0e1);
      color: var(--panel); /* Dark text on primary button */
      font-weight: 600;
      border-color: var(--accent);
    }
    .btn-primary:hover {
        background: linear-gradient(90deg, #4dd0e1, #80deea);
    }
    .container { max-width: 1200px; margin: 22px auto; padding: 18px; }

    /* Estilo para mudar a cor do Ã­cone do calendÃ¡rio */
    input[type="month"]::-webkit-calendar-picker-indicator {
        filter: invert(1); /* Inverte a cor, tornando preto em branco */
        cursor: pointer;
    }
    input[type="month"]::-moz-calendar-picker-indicator {
        filter: invert(1); /* Inverte a cor, tornando preto em branco */
        cursor: pointer;
    }

    /* Cores das categorias baseadas nas bandeiras e tÃ­tulos maiores */
    .category-title {
        font-size: 1.15rem; /* Um pouco maior */
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    #brazilTitle { color: #009739; /* Verde da bandeira do Brasil */ }
    #usaTitle { color: #0A3161; /* Azul escuro da bandeira dos EUA */ }
    #cryptoTitle { color: #8C52FF; /* Um roxo vibrante para Cripto */ }
  </style>
</head>
<body>
  <div id="notice" class="notice" style="display:none"></div>
  <div class="container">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <form id="entryForm" class="lg:col-span-1 p-5 card">
        <h2 class="text-xl font-semibold mb-4 text-white">Add New Entry</h2>
        <div class="mb-3">
          <label class="small muted">Month &amp; Year</label>
          <input id="date" type="month" required class="mt-1 block w-full" />
        </div>
        <div class="mb-3">
          <label class="small muted">Amount (R$)</label>
          <input id="amount" type="number" step="0.01" min="0" placeholder="0.00" required class="mt-1 block w-full" />
        </div>
        <div class="mb-3">
          <label class="small muted">Category</label>
          <select id="category" class="mt-1 w-full">
            <option value="Brazil">Brazil</option>
            <option value="USA">USA</option>
            <option value="Crypto">Crypto</option>
          </select>
        </div>
        <div class="flex gap-2 mt-4">
          <button type="submit" class="btn btn-primary flex-grow">Add Entry</button>
          <button type="button" id="clearAll" class="btn flex-grow muted">Clear All Data</button>
        </div>
        <div class="flex gap-2 mt-3 small">
          <button type="button" id="exportBtn" class="btn muted flex-grow">Export JSON</button>
          <label class="btn muted cursor-pointer flex-grow">Import JSON <input id="importFile" type="file" accept="application/json" class="hidden"/></label>
        </div>
        <p class="muted small mt-4 text-center">Data is saved locally in your browser.</p>
      </form>

      <div class="lg:col-span-2 p-5 card">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3">
          <h2 class="text-xl font-semibold text-white mb-2 sm:mb-0">Cumulative Growth</h2>
          <div class="text-lg font-medium text-white-700">Total Invested: <span id="totalInvestedAmount" class="font-semibold text-accent">R$ 0,00</span></div>
        </div>
        <div style="height:380px;"><canvas id="cumChart"></canvas></div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <section class="card p-4">
        <h3 id="brazilTitle" class="category-title">ðŸ‡§ðŸ‡· Brazil</h3>
        <div id="brazilSummary" class="muted small mt-1"></div>
        <div id="brazilYears" class="mt-3"></div>
      </section>

      <section class="card p-4">
        <h3 id="usaTitle" class="category-title">ðŸ‡ºðŸ‡¸ USA</h3>
        <div id="usaSummary" class="muted small mt-1"></div>
        <div id="usaYears" class="mt-3"></div>
      </section>

      <section class="card p-4">
        <h3 id="cryptoTitle" class="category-title">ðŸª™ Crypto</h3>
        <div id="cryptoSummary" class="muted small mt-1"></div>
        <div id="cryptoYears" class="mt-3"></div>
      </section>
    </div>

    <p class="mt-6 small muted text-center">Tip: Click a year in any category to expand and see all entries for that year.</p>
  </div>

  <script>
    // === CONFIG ===
    const STORAGE_KEY = 'investment_tracker_professional';
    const MAX_YEARS = 40; // safety
    const MAX_MONTHS = 240; // safety
    const chartColors = { /* New color palette for charts */
      Brazil: 'rgba(0, 188, 212, 0.9)', /* Teal - mantendo para o grÃ¡fico */
      USA: 'rgba(255, 159, 64, 0.9)',  /* Orange - mantendo para o grÃ¡fico */
      Crypto: 'rgba(153, 102, 255, 0.9)' /* Purple - mantendo para o grÃ¡fico */
    };
    const mutedTextColor = '#a0a0b0'; // From CSS var(--muted)

    // === HELPERS ===
    const noticeEl = document.getElementById('notice');
    function showNotice(msg, timeout=5000){ noticeEl.textContent=msg; noticeEl.style.display='block'; clearTimeout(noticeEl._t); noticeEl._t=setTimeout(()=>noticeEl.style.display='none', timeout); }

    function loadRaw(key){ try{ const r=localStorage.getItem(key); return r? JSON.parse(r): null; }catch(e){ return null; }}
    function loadEntries(){ const a = loadRaw(STORAGE_KEY); return Array.isArray(a)? a: []; }
    function saveEntries(list){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }catch(e){ console.error('save failed', e); showNotice('Save failed'); }}

    function parseMonthYear(v){ if(!v || typeof v!=='string') return null; if(!/^[0-9]{4}-[0-9]{2}$/.test(v)) return null; const [y,m]=v.split('-').map(Number); if(isNaN(y)||isNaN(m)||m<1||m>12) return null; return {year:y,month:m}; }
    function displayMonth(v){
      const p=parseMonthYear(v);
      if(!p) return v;
      // Formata o mÃªs com a primeira letra em maiÃºscula
      const monthName = new Intl.DateTimeFormat('en-US',{month:'long'}).format(new Date(p.year,p.month-1,1));
      return monthName.charAt(0).toUpperCase() + monthName.slice(1) + ' ' + p.year;
    }

    function validateDataset(arr){ if(!Array.isArray(arr)) return {valid:false}; const cleaned=[]; for(const it of arr){ if(!it || typeof it!=='object') return {valid:false}; const {date, amount, category, id} = it; if(!parseMonthYear(date)) return {valid:false}; const n=Number(amount); if(!isFinite(n)) return {valid:false}; cleaned.push({id: id||crypto.randomUUID(), date, amount: Number(Number(n).toFixed(2)), category: category||'Brazil'}); } return {valid:true, list:cleaned}; }

    function backupAndReset(broken){ try{ const blob = new Blob([JSON.stringify(broken,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='investment-backup-broken.json'; a.click(); URL.revokeObjectURL(url);}catch(e){console.warn('backup failed',e);} localStorage.removeItem(STORAGE_KEY); showNotice('âš ï¸ Corrupted data backed up and cleared. Reloading...'); setTimeout(()=>location.reload(),1300); }

    // === UI Rendering ===
    function groupByCategory(entries){ const map = {Brazil:[], USA:[], Crypto:[]}; entries.forEach(e=>{ if(!map[e.category]) map[e.category]=[]; map[e.category].push(e); }); return map; }
    function aggregateByYear(list){ const byYear={}; let grand=0; list.forEach(e=>{ const p=parseMonthYear(e.date); if(!p) return; byYear[p.year] = (byYear[p.year]||0) + Number(e.amount); grand += Number(e.amount); }); return {byYear,grand}; }

    function renderCategory(cat, list, summaryId, yearsId){ const out = document.getElementById(summaryId); const yearsEl = document.getElementById(yearsId); const {byYear, grand} = aggregateByYear(list); out.textContent = 'Grand total: ' + new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(grand); yearsEl.innerHTML=''; if(Object.keys(byYear).length===0){ yearsEl.innerHTML='<div class="muted small">No data</div>'; return;} Object.keys(byYear).sort((a,b)=>b-a).forEach(y=>{ const total=byYear[y]; const det=document.createElement('details'); det.className='mb-2'; det.innerHTML = `<summary class='flex justify-between items-center p-2 rounded hover:bg-white/5'><div class='flex items-center gap-3'><span class='chev'>â–¶</span><div class='small'>${y}</div></div><div class='small font-medium'>${new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(total)}</div></summary><div class='mt-2 text-sm'><table><thead class='muted small'><tr><th>Month</th><th>Amount</th><th>Action</th></tr></thead><tbody class='year-rows'></tbody></table></div>`; const tbody = det.querySelector('.year-rows'); const rows = list.filter(e=>parseMonthYear(e.date).year==Number(y)).sort((a,b)=>a.date.localeCompare(b.date)); rows.forEach(r=>{ const tr = document.createElement('tr'); tr.innerHTML=`<td class='py-1'>${displayMonth(r.date)}</td><td class='py-1'>${new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(Number(r.amount))}</td><td class='py-1'><button data-id='${r.id}' class='delete-row small' style='color:#ef4444'>Delete</button></td>`; tbody.appendChild(tr); }); yearsEl.appendChild(det); }); }

    function updateTotalInvested(entries) {
      const totalAmount = entries.reduce((sum, entry) => sum + Number(entry.amount), 0);
      document.getElementById('totalInvestedAmount').textContent = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(totalAmount);
    }

    // === CHARTS ===
    let cumChart; // Only one chart now
    function createCharts(){
      const c1 = document.getElementById('cumChart').getContext('2d');
      cumChart = new Chart(c1, {
        type:'line',
        data:{labels:[], datasets:[]},
        options:{
          responsive:true,
          maintainAspectRatio:false,
          interaction:{mode:'index',intersect:false},
          plugins:{
            legend:{labels:{color:mutedTextColor}}, // Use new muted color
            tooltip: {
                backgroundColor: 'rgba(32, 32, 64, 0.9)', // Tooltip background
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: 'rgba(0, 188, 212, 0.2)',
                borderWidth: 1,
            }
          },
          scales:{
            x:{
              ticks:{color:mutedTextColor},
              grid:{color:'rgba(255,255,255,0.03)'}
            },
            y:{
              ticks:{color:mutedTextColor},
              grid:{color:'rgba(255,255,255,0.03)'}
            }
          }
        }
      });
    }

    function renderCharts(entries){
      const valid = entries.filter(e=>parseMonthYear(e.date));
      if(valid.length===0){
        cumChart.data.labels=[];
        cumChart.data.datasets=[];
        cumChart.update();
        return;
      }

      // Build year list (sorted ascending)
      const yearsSet = new Set(valid.map(e=>parseMonthYear(e.date).year));
      let years = Array.from(yearsSet).sort((a,b)=>a-b);
      if(years.length>MAX_YEARS) years = years.slice(years.length-MAX_YEARS);

      // Yearly totals per category
      const cats = ['Brazil','USA','Crypto'];
      const yearly = {Brazil:[], USA:[], Crypto:[]};
      years.forEach(y=>{
        cats.forEach(c=>{
          const tot = valid.filter(e=>parseMonthYear(e.date).year===y && e.category===c).reduce((s,e)=>s+Number(e.amount),0);
          yearly[c].push(Number(tot.toFixed(2)));
        });
      });

      // Cumulative per year
      const cumulative = {Brazil:[], USA:[], Crypto:[]};
      cats.forEach(c=>{
        let acc=0;
        yearly[c].forEach(v=>{
          acc+=v;
          cumulative[c].push(Number(acc.toFixed(2)));
        });
      });

      const labels = years.map(y=>String(y));
      const ds = cats.map(c=>({
        label:c,
        data:cumulative[c],
        borderColor:chartColors[c], // Use specific colors
        tension:0.3, // Slightly smoother curves
        pointRadius:4,
        pointBackgroundColor: chartColors[c],
        backgroundColor:'transparent'
      }));
      cumChart.data.labels = labels;
      cumChart.data.datasets = ds;
      cumChart.update();
    }

    // === ACTIONS ===
    function attachDeleteHandlers(){ document.querySelectorAll('.delete-row').forEach(btn=> btn.onclick = ev=>{ const id = ev.target.dataset.id; if(!confirm('Delete entry?')) return; const arr = loadEntries(); const idx = arr.findIndex(i=>i.id===id); if(idx>-1){ arr.splice(idx,1); saveEntries(arr); renderAll(); } }); }

    function renderAll(){
      const entries = loadEntries().filter(e=>parseMonthYear(e.date));
      const grouped = groupByCategory(entries);
      renderCategory('Brazil', grouped['Brazil'], 'brazilSummary','brazilYears');
      renderCategory('USA', grouped['USA'], 'usaSummary','usaYears');
      renderCategory('Crypto', grouped['Crypto'],'cryptoSummary','cryptoYears');
      renderCharts(entries);
      updateTotalInvested(entries); // Update the total invested amount
      attachDeleteHandlers();
    }

    // === FORM HANDLERS ===
    document.getElementById('entryForm').addEventListener('submit', e=>{ e.preventDefault(); const date = document.getElementById('date').value; const amount = document.getElementById('amount').value; const category = document.getElementById('category').value; if(!parseMonthYear(date) || !amount) return showNotice('Please select month and enter amount'); const arr = loadEntries(); arr.push({id:crypto.randomUUID(), date, amount: Number(Number(amount).toFixed(2)), category}); saveEntries(arr); document.getElementById('amount').value=''; renderAll(); showNotice('Saved âœ“',1200); });

    document.getElementById('clearAll').addEventListener('click', ()=>{ if(!confirm('Delete ALL entries? This cannot be undone unless you have exported a backup.')) return; localStorage.removeItem(STORAGE_KEY); renderAll(); showNotice('All data cleared'); });

    document.getElementById('exportBtn').addEventListener('click', ()=>{ const data = loadEntries(); const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='investment-backup.json'; a.click(); URL.revokeObjectURL(url); showNotice('Exported backup'); });

    document.getElementById('importFile').addEventListener('change', ev=>{ const file = ev.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = e=>{ try{ const parsed = JSON.parse(e.target.result); const v = validateDataset(parsed); if(!v.valid) return alert('Import failed: invalid file'); saveEntries(v.list); renderAll(); showNotice('Import successful'); }catch(err){ alert('Import failed: '+err.message); } }; reader.readAsText(file); ev.target.value=null; });

    // === INIT ===
    (function init(){ try{
        // If existing data present, validate; if invalid -> backup+reset
        const raw = loadRaw(STORAGE_KEY);
        if(raw){ const v = validateDataset(raw); if(!v.valid){ backupAndReset(raw); return; } else { saveEntries(v.list); } }
        createCharts(); renderAll(); // set default month
        const t = new Date(); document.getElementById('date').value = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}`;
      }catch(e){ console.error(e); backupAndReset(loadRaw(STORAGE_KEY)); } })();
  </script>
</body>
</html>
