<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Investment Tracker â€” Futuristic Neon v4</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--bg:#050505;--panel:#071014;--neon:#00ff66;--muted:#9aa6b2}
    html,body{height:100%}
    body{background:linear-gradient(180deg,#050505 0%, #070707 100%);color:#eafff2;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;margin:0}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.04); border-radius:12px}
    .neon{box-shadow:0 0 18px rgba(0,255,102,0.06), inset 0 1px 0 rgba(255,255,255,0.02)}
    .glow{filter:drop-shadow(0 0 10px rgba(0,255,102,0.18))}
    details summary{list-style:none;cursor:pointer}
    details[open] summary .chev{transform:rotate(90deg)}
    label{display:block}
    select, input[type="month"], input[type="number"]{appearance:none; -webkit-appearance:none}
    select{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:.5rem;border-radius:8px;color:var(--neon);}
    select option{background:#0a0a0a;color:#eafff2}
    .notice{position:fixed;left:50%;transform:translateX(-50%);top:18px;z-index:9999;padding:.6rem 1rem;border-radius:8px;background:rgba(9,9,9,0.75);backdrop-filter:blur(6px);color:var(--neon);border:1px solid rgba(0,255,102,0.12);box-shadow:0 6px 30px rgba(0,255,102,0.04)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:.35rem .5rem;text-align:left;font-size:.95rem}
    .muted{color:var(--muted)}
    .small{font-size:.85rem}
    .btn{padding:.45rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(90deg, rgba(0,0,0,0.3), rgba(255,255,255,0.01));cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,var(--neon),#8effb6);color:#041006;font-weight:600}
    .container{max-width:1100px;margin:22px auto;padding:18px}
  </style>
</head>
<body>
  <div id="notice" class="notice" style="display:none"></div>
  <div class="container">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <form id="entryForm" class="lg:col-span-1 p-4 card neon">
        <div class="mb-3">
          <label class="small muted">Month &amp; Year</label>
          <input id="date" type="month" required class="mt-1 block w-full rounded p-2 bg-transparent text-white small" />
        </div>
        <div class="mb-3">
          <label class="small muted">Amount (R$)</label>
          <input id="amount" type="number" step="0.01" min="0" placeholder="0.00" required class="mt-1 block w-full rounded p-2 bg-transparent text-white small" />
        </div>
        <div class="mb-3">
          <label class="small muted">Category</label>
          <select id="category" class="mt-1 w-full small">
            <option value="Brazil">Brazil</option>
            <option value="USA">USA</option>
            <option value="Crypto">Crypto</option>
          </select>
        </div>
        <div class="flex gap-2 mt-4">
          <button type="submit" class="btn btn-primary">Add</button>
          <button type="button" id="clearAll" class="btn muted">Clear all</button>
        </div>
        <div class="flex gap-2 mt-3 small">
          <button type="button" id="exportBtn" class="btn muted">Export JSON</button>
          <label class="btn muted cursor-pointer">Import JSON <input id="importFile" type="file" accept="application/json" class="hidden"/></label>
        </div>
        <p class="muted small mt-3">Saved locally in your browser. Auto-backup will run if corrupted data is found.</p>
      </form>

      <div class="lg:col-span-2 p-4 card neon">
        <div class="flex items-center justify-between">
          <div>
            <div class="small muted">Cumulative (growth over time)</div>
          </div>
        </div>
        <div style="height:220px;margin-top:8px"><canvas id="cumChart"></canvas></div>
        <div class="mt-4 small muted">Yearly totals</div>
        <div style="height:220px;margin-top:8px"><canvas id="yearChart"></canvas></div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="card p-4 neon">
        <h3 class="small">ðŸ‡§ðŸ‡· Brazil</h3>
        <div id="brazilSummary" class="muted small mt-1"></div>
        <div id="brazilYears" class="mt-3"></div>
      </section>

      <section class="card p-4 neon">
        <h3 class="small">ðŸ‡ºðŸ‡¸ USA</h3>
        <div id="usaSummary" class="muted small mt-1"></div>
        <div id="usaYears" class="mt-3"></div>
      </section>

      <section class="card p-4 neon">
        <h3 class="small">ðŸª™ Crypto</h3>
        <div id="cryptoSummary" class="muted small mt-1"></div>
        <div id="cryptoYears" class="mt-3"></div>
      </section>
    </div>

    <div class="mt-6 small muted">Tip: click a year to expand and see all inputs for that year.</div>
  </div>

  <script>
    // === CONFIG ===
    const STORAGE_KEY = 'investment_tracker_neon_v4';
    const MAX_YEARS = 40; // safety
    const MAX_MONTHS = 240; // safety
    const neonColor = 'rgba(0,255,102,0.95)';

    // === HELPERS ===
    const noticeEl = document.getElementById('notice');
    function showNotice(msg, timeout=5000){ noticeEl.textContent=msg; noticeEl.style.display='block'; clearTimeout(noticeEl._t); noticeEl._t=setTimeout(()=>noticeEl.style.display='none', timeout); }

    function loadRaw(key){ try{ const r=localStorage.getItem(key); return r? JSON.parse(r): null; }catch(e){ return null; }}
    function loadEntries(){ const a = loadRaw(STORAGE_KEY); return Array.isArray(a)? a: []; }
    function saveEntries(list){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }catch(e){ console.error('save failed', e); showNotice('Save failed'); }}

    function parseMonthYear(v){ if(!v || typeof v!=='string') return null; if(!/^[0-9]{4}-[0-9]{2}$/.test(v)) return null; const [y,m]=v.split('-').map(Number); if(isNaN(y)||isNaN(m)||m<1||m>12) return null; return {year:y,month:m}; }
    function displayMonth(v){ const p=parseMonthYear(v); if(!p) return v; return new Intl.DateTimeFormat('pt-BR',{month:'short'}).format(new Date(p.year,p.month-1,1)) + ' ' + p.year; }

    function validateDataset(arr){ if(!Array.isArray(arr)) return {valid:false}; const cleaned=[]; for(const it of arr){ if(!it || typeof it!=='object') return {valid:false}; const {date, amount, category, id} = it; if(!parseMonthYear(date)) return {valid:false}; const n=Number(amount); if(!isFinite(n)) return {valid:false}; cleaned.push({id: id||crypto.randomUUID(), date, amount: Number(Number(n).toFixed(2)), category: category||'Brazil'}); } return {valid:true, list:cleaned}; }

    function backupAndReset(broken){ try{ const blob = new Blob([JSON.stringify(broken,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='investment-backup-broken.json'; a.click(); URL.revokeObjectURL(url);}catch(e){console.warn('backup failed',e);} localStorage.removeItem(STORAGE_KEY); showNotice('âš ï¸ Corrupted data backed up and cleared. Reloading...'); setTimeout(()=>location.reload(),1300); }

    // === UI Rendering ===
    function groupByCategory(entries){ const map = {Brazil:[], USA:[], Crypto:[]}; entries.forEach(e=>{ if(!map[e.category]) map[e.category]=[]; map[e.category].push(e); }); return map; }
    function aggregateByYear(list){ const byYear={}; let grand=0; list.forEach(e=>{ const p=parseMonthYear(e.date); if(!p) return; byYear[p.year] = (byYear[p.year]||0) + Number(e.amount); grand += Number(e.amount); }); return {byYear,grand}; }

    function renderCategory(cat, list, summaryId, yearsId){ const out = document.getElementById(summaryId); const yearsEl = document.getElementById(yearsId); const {byYear, grand} = aggregateByYear(list); out.textContent = 'Grand total: ' + new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(grand); yearsEl.innerHTML=''; if(Object.keys(byYear).length===0){ yearsEl.innerHTML='<div class="muted small">No data</div>'; return;} Object.keys(byYear).sort((a,b)=>b-a).forEach(y=>{ const total=byYear[y]; const det=document.createElement('details'); det.className='mb-2'; det.innerHTML = `<summary class='flex justify-between items-center p-2 rounded hover:bg-white/2'><div class='flex items-center gap-3'><span class='chev'>â–¶</span><div class='small'>${y}</div></div><div class='small font-medium'>${new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(total)}</div></summary><div class='mt-2 text-sm'><table><thead class='muted small'><tr><th>Month</th><th>Amount</th><th>Action</th></tr></thead><tbody class='year-rows'></tbody></table></div>`; const tbody = det.querySelector('.year-rows'); const rows = list.filter(e=>parseMonthYear(e.date).year==Number(y)).sort((a,b)=>a.date.localeCompare(b.date)); rows.forEach(r=>{ const tr = document.createElement('tr'); tr.innerHTML=`<td class='py-1'>${displayMonth(r.date)}</td><td class='py-1'>${new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(Number(r.amount))}</td><td class='py-1'><button data-id='${r.id}' class='delete-row small' style='color:#ff8b8b'>Delete</button></td>`; tbody.appendChild(tr); }); yearsEl.appendChild(det); }); }

    // === CHARTS ===
    let cumChart, yearChart;
    function createCharts(){ const c1 = document.getElementById('cumChart').getContext('2d'); cumChart = new Chart(c1, {type:'line', data:{labels:[], datasets:[]}, options:{responsive:true, maintainAspectRatio:false, interaction:{mode:'index',intersect:false}, plugins:{legend:{labels:{color:'#cbd5e1'}}}, scales:{x:{ticks:{color:'#9ca3af'}, grid:{color:'rgba(255,255,255,0.03)'}}, y:{ticks:{color:'#9ca3af'}, grid:{color:'rgba(255,255,255,0.03)'}}}}}); const c2 = document.getElementById('yearChart').getContext('2d'); yearChart = new Chart(c2, {type:'line', data:{labels:[], datasets:[]}, options:{responsive:true, maintainAspectRatio:false, interaction:{mode:'index',intersect:false}, plugins:{legend:{labels:{color:'#cbd5e1'}}}, scales:{x:{ticks:{color:'#9ca3af'}, grid:{color:'rgba(255,255,255,0.03)'}}, y:{ticks:{color:'#9ca3af'}, grid:{color:'rgba(255,255,255,0.03)'}}}}}); }

    function renderCharts(entries){ const valid = entries.filter(e=>parseMonthYear(e.date)); if(valid.length===0){ cumChart.data.labels=[]; cumChart.data.datasets=[]; cumChart.update(); yearChart.data.labels=[]; yearChart.data.datasets=[]; yearChart.update(); return; }

      // Build year list (sorted ascending)
      const yearsSet = new Set(valid.map(e=>parseMonthYear(e.date).year)); let years = Array.from(yearsSet).sort((a,b)=>a-b);
      if(years.length>MAX_YEARS) years = years.slice(years.length-MAX_YEARS);

      // Yearly totals per category
      const cats = ['Brazil','USA','Crypto'];
      const yearly = {Brazil:[], USA:[], Crypto:[]};
      years.forEach(y=>{ cats.forEach(c=>{ const tot = valid.filter(e=>parseMonthYear(e.date).year===y && e.category===c).reduce((s,e)=>s+Number(e.amount),0); yearly[c].push(Number(tot.toFixed(2))); }); });

      // Cumulative per year
      const cumulative = {Brazil:[], USA:[], Crypto:[]};
      cats.forEach(c=>{ let acc=0; yearly[c].forEach(v=>{ acc+=v; cumulative[c].push(Number(acc.toFixed(2))); }); });

      const labels = years.map(y=>String(y));
      const ds = cats.map(c=>({label:c, data:cumulative[c], borderColor:neonColor, tension:0.25, pointRadius:3, backgroundColor:'transparent'}));
      cumChart.data.labels = labels; cumChart.data.datasets = ds; cumChart.update();

      const ds2 = cats.map(c=>({label:c, data:yearly[c], borderColor:neonColor, tension:0.25, pointRadius:3, backgroundColor:'transparent'}));
      yearChart.data.labels = labels; yearChart.data.datasets = ds2; yearChart.update(); }

    // === ACTIONS ===
    function attachDeleteHandlers(){ document.querySelectorAll('.delete-row').forEach(btn=> btn.onclick = ev=>{ const id = ev.target.dataset.id; if(!confirm('Delete entry?')) return; const arr = loadEntries(); const idx = arr.findIndex(i=>i.id===id); if(idx>-1){ arr.splice(idx,1); saveEntries(arr); renderAll(); } }); }

    function renderAll(){ const entries = loadEntries().filter(e=>parseMonthYear(e.date)); const grouped = groupByCategory(entries); renderCategory('Brazil', grouped['Brazil'], 'brazilSummary','brazilYears'); renderCategory('USA', grouped['USA'], 'usaSummary','usaYears'); renderCategory('Crypto', grouped['Crypto'],'cryptoSummary','cryptoYears'); renderCharts(entries); attachDeleteHandlers(); }

    // === FORM HANDLERS ===
    document.getElementById('entryForm').addEventListener('submit', e=>{ e.preventDefault(); const date = document.getElementById('date').value; const amount = document.getElementById('amount').value; const category = document.getElementById('category').value; if(!parseMonthYear(date) || !amount) return showNotice('Please select month and enter amount'); const arr = loadEntries(); arr.push({id:crypto.randomUUID(), date, amount: Number(Number(amount).toFixed(2)), category}); saveEntries(arr); document.getElementById('amount').value=''; renderAll(); showNotice('Saved âœ“',1200); });

    document.getElementById('clearAll').addEventListener('click', ()=>{ if(!confirm('Delete ALL entries? This cannot be undone unless you have exported a backup.')) return; localStorage.removeItem(STORAGE_KEY); renderAll(); showNotice('All data cleared'); });

    document.getElementById('exportBtn').addEventListener('click', ()=>{ const data = loadEntries(); const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='investment-backup.json'; a.click(); URL.revokeObjectURL(url); showNotice('Exported backup'); });

    document.getElementById('importFile').addEventListener('change', ev=>{ const file = ev.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = e=>{ try{ const parsed = JSON.parse(e.target.result); const v = validateDataset(parsed); if(!v.valid) return alert('Import failed: invalid file'); saveEntries(v.list); renderAll(); showNotice('Import successful'); }catch(err){ alert('Import failed: '+err.message); } }; reader.readAsText(file); ev.target.value=null; });

    // === INIT ===
    (function init(){ try{
        // If existing data present, validate; if invalid -> backup+reset
        const raw = loadRaw(STORAGE_KEY);
        if(raw){ const v = validateDataset(raw); if(!v.valid){ backupAndReset(raw); return; } else { saveEntries(v.list); } }
        createCharts(); renderAll(); // set default month
        const t = new Date(); document.getElementById('date').value = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}`;
      }catch(e){ console.error(e); backupAndReset(loadRaw(STORAGE_KEY)); } })();
  </script>
</body>
</html>
